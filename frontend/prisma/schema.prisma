generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. AUTENTICAÇÃO E PERFIS
model Usuario {
  id              String  @id @default(uuid())
  nome            String
  email           String  @unique
  senha           String
  perfil          Perfil
  empresaPadraoId String? @map("empresa_padrao_id")
  unidadePadraoId String? @map("unidade_padrao_id")
  ativo           Boolean @default(true)

  empresaPadrao Empresa? @relation(fields: [empresaPadraoId], references: [id])
  unidadePadrao Unidade? @relation(fields: [unidadePadraoId], references: [id])
  trocarSenha   Boolean  @default(true) @map("trocar_senha")
  area          Area     @default(GERAL)

  @@map("usuarios")
}

enum Perfil {
  ADMIN
  GESTOR
  PCM
  SEGURANCA
  ESTOQUE
  CUSTO
  RH
  OPERACIONAL
}

enum Area {
  GERAL
  PCM
  FROTA
  COLHEITA
  SILVICULTURA
  CARREGAMENTO
  ALMOXARIFADO
  RH
  FINANCEIRO
  SEGURANCA
}

// 2. CADASTROS BASE
model Empresa {
  id           String  @id @default(uuid())
  nomeFantasia String  @map("nome_fantasia")
  razaoSocial  String  @map("razao_social")
  cnpj         String  @unique
  ativo        Boolean @default(true)

  unidades  Unidade[]
  veiculos  Veiculo[]
  usuarios  Usuario[]

  @@map("empresas")
}

model Unidade {
  id          String  @id @default(uuid())
  nomeUnidade String  @map("nome_unidade")
  empresaId   String  @map("empresa_id")
  cidade      String
  estado      String
  ativo       Boolean @default(true)

  empresa   Empresa   @relation(fields: [empresaId], references: [id])
  veiculos  Veiculo[]
  usuarios  Usuario[]

  @@map("unidades")
}

model Veiculo {
  id              String            @id @default(uuid())
  codigoInterno   String            @unique @map("codigo_interno")
  placa           String?
  tipoVeiculo     String            @map("tipo_veiculo")
  fabricante      String
  modelo          String
  ano             Int
  empresaId       String            @map("empresa_id")
  unidadeId       String            @map("unidade_id")
  status          StatusOperacional @map("status_operacional")
  kmAtual         Int               @default(0) @map("km_atual")
  horimetroAtual  Int               @default(0) @map("horimetro_atual")
  critico         Boolean           @default(false)
  observacoes     String?
  categoria       String?
  moduloSistema   String?           @map("modulo_sistema")
  dataAtualizacaoHorimetro DateTime? @map("data_atualizacao_horimetro")
  semanaPreventiva Int?             @map("semana_preventiva")

  empresa     Empresa     @relation(fields: [empresaId], references: [id])
  unidade     Unidade     @relation(fields: [unidadeId], references: [id])
  os          OrdemServico[]
  planos      PlanoManutencao[]
  pneus       Pneu[]
  boletinsPneu BoletimPneu[]
  documentos   DocumentoFrota[]

  @@map("veiculos_frota")
}

enum StatusOperacional {
  DISPONIVEL
  EM_OPERACAO
  EM_MANUTENCAO
  PARADO
  DESATIVADO
}

// 4. MÓDULO PCM
model OrdemServico {
  id             String    @id @default(uuid())
  numeroOS       Int       @default(autoincrement()) @map("numero_os")
  veiculoId      String    @map("veiculo_id")
  tipoOS         TipoOS    @map("tipo_os")
  origem         String?
  descricao      String
  dataAbertura   DateTime  @default(now()) @map("data_abertura")
  dataPlanejada  DateTime? @map("data_planejada")
  dataInicio     DateTime? @map("data_inicio")
  dataConclusao  DateTime? @map("data_conclusao")
  status         StatusOS  @map("status_os")
  tempoParada    Float?    @map("tempo_parada_horas")
  responsavelPcm String?   @map("responsavel_pcm")

  // Parâmetros Mestre
  motivoId      String?   @map("motivo_id")
  sistemaId     String?   @map("sistema_id")
  subSistemaId  String?   @map("sub_sistema_id")

  veiculo    Veiculo    @relation(fields: [veiculoId], references: [id])
  motivo     OsMotivo?  @relation(fields: [motivoId], references: [id])
  sistema    OsSistema? @relation(fields: [sistemaId], references: [id])
  subSistema OsSubSistema? @relation(fields: [subSistemaId], references: [id])

  @@map("ordens_servico")
}

enum TipoOS {
  PREVENTIVA
  CORRETIVA
  INSPECAO
  MELHORIA
}

enum StatusOS {
  ABERTA
  PLANEJADA
  EM_EXECUCAO
  CONCLUIDA
}

model PlanoManutencao {
  id              String           @id @default(uuid())
  veiculoId       String           @map("veiculo")
  tipo            String           @map("tipo_manutencao") // Ex: Motor, Hidraulico (No form: Tipo)
  modulo          String?          // No form: Módulo
  ultimoHorimetro Int              @default(0) @map("ultimo_horimetro") // No form: Último Horímetro
  intervalo       Int              @map("intervalo_horas") // No form: Intervalo
  dataAtualizacao DateTime         @default(now()) @map("data_atualizacao") // No form: Data da Atualização
  status          StatusPreventiva @default(NO_PRAZO) @map("status_preventiva")

  veiculo Veiculo @relation(fields: [veiculoId], references: [id])

  @@map("planos_manutencao")
}

enum TipoGatilho {
  KM
  HORAS
  DIAS
}

enum StatusPreventiva {
  NO_PRAZO
  ATENCAO
  ATRASADO
}

model Pneu {
  id             String  @id @default(uuid())
  codigoPneu     String  @unique @map("codigo_pneu")
  medida         String
  vida           Int     @default(1) // 1ª vida, 2ª vida...
  status         String
  veiculoAtualId String? @map("veiculo_atual")
  posicao        String?
  sulcoAtualMm   Float   @map("sulco_atual_mm")

  veiculo Veiculo? @relation(fields: [veiculoAtualId], references: [id])
  historicoInspecao ItemBoletimPneu[]

  @@map("pneus_frota")
}

model SystemParameters {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  group       String   @default("GERAL") // GERAL, NOTIFICACAO, INTEGRACAO, ETC
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_parameters")
}

model OsMotivo {
  id    String @id @default(uuid())
  nome  String @unique
  ativo Boolean @default(true)
  os    OrdemServico[]

  @@map("os_motivos")
}

model OsSistema {
  id          String @id @default(uuid())
  nome        String @unique
  ativo       Boolean @default(true)
  subSistemas OsSubSistema[]
  os          OrdemServico[]

  @@map("os_sistemas")
}

model OsSubSistema {
  id        String @id @default(uuid())
  nome      String
  sistemaId String @map("sistema_id")
  ativo     Boolean @default(true)

  sistema   OsSistema @relation(fields: [sistemaId], references: [id])
  os        OrdemServico[]

  @@unique([nome, sistemaId])
  @@map("os_sub_sistemas")
}

model BoletimPneu {
  id          String   @id @default(uuid())
  veiculoId   String   @map("veiculo_id")
  data        DateTime
  km          Int
  condicao    String?
  observacoes String?
  criadoEm    DateTime @default(now()) @map("criado_em")

  itens       ItemBoletimPneu[]
  veiculo     Veiculo @relation(fields: [veiculoId], references: [id])

  @@map("boletins_pneu")
}

model ItemBoletimPneu {
  id        String @id @default(uuid())
  boletimId String @map("boletim_id")
  posicao   String
  sulcoMm   Float  @map("sulco_mm")
  pneuId    String? @map("pneu_id")

  boletim   BoletimPneu @relation(fields: [boletimId], references: [id])
  pneu      Pneu?       @relation(fields: [pneuId], references: [id])

  @@map("itens_boletim_pneu")
}

model DocumentoFrota {
  id           String    @id @default(uuid())
  veiculoId    String    @map("veiculo_id")
  tipo         String    // LAUDO, CRLV, IMPLEMENTO, TACOGRAFO, CIV_CIPP
  numero       String?
  dataEmissao  DateTime? @map("data_emissao")
  dataValidade DateTime? @map("data_validade")
  
  veiculo      Veiculo   @relation(fields: [veiculoId], references: [id])
  
  @@unique([veiculoId, tipo])
  @@map("documentos_frota")
}
